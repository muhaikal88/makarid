# ===============================
# HTTP → HTTPS (managed by Certbot)
# ===============================
server {
    if ($host = career.luckycell.co.id) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = hr.luckycell.co.id) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = luckycell.co.id) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = www.makar.id) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = makar.id) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name makar.id www.makar.id
                luckycell.co.id
                hr.luckycell.co.id
                career.luckycell.co.id;

    return 301 https://$host$request_uri;
}

# ===============================
# HTTPS
# ===============================
server {
    listen 443 ssl;
    server_name makar.id www.makar.id
                luckycell.co.id
                hr.luckycell.co.id
                career.luckycell.co.id;

    ssl_certificate /etc/letsencrypt/live/makar.id/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/makar.id/privkey.pem; # managed by Certbot

    root /var/www/makar;
    index index.html;

    client_max_body_size 10M;

    # API → Backend
    location /api {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Original-Host $host;
    }

    # Crawler handler (named location)
    location @crawler {
        proxy_pass http://127.0.0.1:8001/api/og-meta?path=$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Original-Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Frontend - detect crawlers via error_page trick
    location / {
        error_page 418 = @crawler;
        if ($http_user_agent ~* "facebookexternalhit|WhatsApp|Twitterbot|LinkedInBot|Slackbot|TelegramBot|Discordbot") {
            return 418;
        }
        try_files $uri /index.html;
    }
}
